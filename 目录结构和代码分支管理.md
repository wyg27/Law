## 代码分支管理

目前，SteerEV 项目的代码更新（生产环境）由总部的2位印度同事负责。所以，在代码分支的管理上我们暂时延续他们既定的习惯。

- 做新功能的时候，先从 `staging` 分支开辟自己的工作分支。
- 完成任务后，以 pull request 的方式向名为 `Rushi Rami` 的同事提起 merge 请求，由他将你的分支并入 `staging` 分支。

余下的事就不用担心了。

### 关于测试环境

因为 SteerEV 是一个全新的项目，无论是 PHP 版本还是 Laravel 都是最新的，所以在本地搭建测试环境就变得十分容易了，可以参考《[SteerEV 代码部署备忘](https://facedrive.atlassian.net/wiki/spaces/serversidewiki/pages/77692939/SteerEV)》。有鉴于此，暂时没有类似 Docker 的环境提供给大家。不过，我们还是有一个线上的测试环境，域名是 [https://evtest.steerev.com](https://evtest.steerev.com)。这个线上测试环境会在稍后配置为“自动拉取代码”，让它成为之前我们所熟悉的“沙盒”。但是，希望大家不要养成依赖沙盒服务器的习惯，而是应该多思考如何把代码写得更有条理，更容易实现单元测试，这样才能做到“自己的屁股自己擦”。话虽然粗鄙，但这是每一个程序员都应该具备的基本素质。而不是像以前那样，写完的代码是什么样子完全不清楚，没报错就是“成功”，报错了再打补丁。

## 目录结构

以下目录结构以 Laravel 9 为基础。

### Controller

- 所有 API 相关的 controller 都应该放在 `app/Http/Controllers/Api` 内。
- 可以根据业务/模块进一步建立子目录，比如 `app/Http/Controllers/Api/Order` 。

### Model

- 所有 model 都应该放在 `app/Models` 内。
- 可以根据业务/模块进一步建立子目录，比如 `app/Models/ActiveCampaign` 。

### Repository

- 所有的 repository 都应该放在 `app/Repositories` 内。
- 可以根据业务/模块进一步建立子目录，比如 `app/Repositories/ApiDemo` 。

这里解释一下什么是“repository”。其实，它叫什么名字并不重要，它的目的是在 model 之上增加一个“层”，用来放置与 model 有关的 CURD 操做，也有可能是比 CURD 稍微复杂一点的，掺杂了少量业务逻辑的操作。多出的这一“层”令我们可以更好的将操纵数据的业务逻辑与数据本身隔离开，而隔离开的好处之一就是让我们的代码可以单元测试。

枯燥的解释不如一个好的例子。先来看一段无法进行单元测试的业务逻辑代码：

```php
<?php

class Coupon {
    public calDiscount(Order $order) {
        return $order->subtotal * (70/100);
    }
}
```
上面的代码很简单，就是传入一个订单的 model 对象，然后计算它减免30%后的价值是多少。但是，因为 `calDiscount()` 限定了传入的参数必须是一个 model，所以我们很难为它编写单元测试。原因是我们在测试中必须依赖数据库连接才能生成一个订单的 model 对象，这意味着测试环境变得复杂了，还要频繁的在数据库中制造“假数据”来满足不同的测试条件。

你可能会说“没事，其实在不连接数据库的情况下我们也可以 new 一个订单的 model 对象出来进行测试”；是的，你说的方法我也知道，我甚至还知道最新的 Laravel 框架允许我们在单元测试中引入数据库连接。可惜，这并不是正确的方式。Laravel 框架提供的功能只是一种面对现实的无奈妥协 —— 程序员们擅于写出高度耦合的业务逻辑，而这样的业务逻辑在单元测试中难以脱离数据库连接。

那么，再来看看增加了 repository 之后的写法：

```php
<?php

class Coupon {
    public calDiscount(OrderRepository $order) {
        return $order->subtotal * (70/100);
    }
}
```

### 其它自定义 Class 或“Helper”

- 所有的 自定义 Class 或“Helper”都应该放在 `app/Classes` 内。
- 可以根据业务/模块进一步建立子目录，比如 `app/Classes/ApiDemo` 。
